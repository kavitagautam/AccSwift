<div class="col-md-12 p-0">
  <kendo-grid
    [data]="entryArray.value"
    (cancel)="cancelHandler($event)"
    (save)="saveHandler($event)"
    (add)="addHandler($event)"
    (remove)="removeHandler($event)"
  >
    <ng-template kendoGridToolbarTemplate>
      <button kendoGridAddCommand>Add New</button>
    </ng-template>

    <kendo-grid-column
      field="ProductID"
      title="Product"
      width="280"
      [hidden]="!columns.includes('ProductID')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <div class="form-group mt-4">
          <div class="col-md-11 pl-0">
            <kendo-dropdownlist
              class="form-control"
              [data]="productList"
              [filterable]="true"
              [textField]="'CodeName'"
              [valueField]="'ProductID'"
              [valuePrimitive]="true"
              [formControl]="entryArray.controls[rowIndex].get('ProductID')"
              (filterChange)="productDDFilter($event, rowIndex)"
              (valueChange)="handleProductChange($event, rowIndex)"
            >
              <ng-template kendoDropDownListItemTemplate let-dataItem>
                <span class="template">{{ dataItem.CodeName }} </span>
              </ng-template>
              <ng-template kendoDropDownListNoDataTemplate>
                <div>
                  No data found.
                  <br />
                  <button class="k-button" (click)="addNewProduct(addProduct)">
                    Add new product
                  </button>
                </div>
              </ng-template>
            </kendo-dropdownlist>
          </div>
          <div class="col-md-1 p-0">
            <a (click)="openProductModal(rowIndex)"
              ><i
                class="fa fa-eye pull-right ledgerSelectIcon"
                style="margin: 0px; font-size: 16px; position: relative;"
                aria-hidden="true"
              ></i>
            </a>
          </div>

          <div
            class="col-md-12"
            *ngIf="entryArray.controls[rowIndex].get('QtyUnitName').value"
          >
            <span
              ><b>Unit : </b>&nbsp; &nbsp;{{
                entryArray.controls[rowIndex].get("QtyUnitName").value
              }}
            </span>
            <button
              #anchor
              style="
                color: blue;
                font-size: 12px;
                cursor: pointer;
                padding: 0px;
              "
              class="btn"
              (click)="unitToggle(rowIndex)"
            >
              Change
            </button>
            <kendo-popup
              #popup
              [anchor]="anchor"
              *ngIf="showUnitPopup && rowPopupIndexUnit == rowIndex"
              (anchorViewportLeave)="unitToggle(null)"
            >
              <div class="contentPopup">
                <div class="form-group">
                  <label>Unit</label>
                  <kendo-dropdownlist
                    class="form-control"
                    [data]="relatedUnits"
                    textField="Name"
                    valueField="ID"
                    [valuePrimitive]="true"
                    [formControl]="
                      entryArray.controls[rowIndex].get('QtyUnitID')
                    "
                  >
                  </kendo-dropdownlist>
                </div>
                <button
                  class="btn btn-primary"
                  style="margin: auto; display: table;"
                  (click)="unitToggle(null)"
                >
                  Ok
                </button>
              </div>
            </kendo-popup>
          </div>
        </div>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="LedgerName"
      title="Particulars Or Accounting Head"
      width="300"
      [hidden]="!columns.includes('LedgerName')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <div class="form-group mt-4">
          <div class="col-md-11 pl-0">
            <kendo-dropdownlist
              class="form-control"
              [data]="ledgerList"
              [filterable]="true"
              [textField]="'CodeName'"
              [valueField]="'LedgerID'"
              [valuePrimitive]="true"
              [formControl]="entryArray.controls[rowIndex].get('LedgerID')"
              (filterChange)="ledgerDDFilter($event, rowIndex)"
              (valueChange)="handleLedgerChange($event, rowIndex)"
            >
              <ng-template kendoDropDownListItemTemplate let-dataItem>
                <span class="template">{{ dataItem.CodeName }} </span>
              </ng-template>
              <ng-template kendoDropDownListNoDataTemplate>
                <div>
                  No data found.
                  <br />
                  <!-- <button class="k-button" (click)="addNewProduct(addProduct)">
                  Add new product
                </button> -->
                </div>
              </ng-template>
            </kendo-dropdownlist>
          </div>
          <div class="col-md-1 p-0">
            <a (click)="openLedgerModal(rowIndex)"
              ><i
                class="fa fa-eye pull-right ledgerSelectIcon"
                style="margin: 0px; font-size: 16px; position: relative;"
                aria-hidden="true"
              ></i>
            </a>
          </div>
        </div>
        <!-- <div class="col-xs-12 col-md-12 p-0">
          <div class="col-md-4 pl-0">
            <input
              #input
              class="k-textbox"
              style="width: 100px;"
              placeholder="Ledger Code"
              [formControl]="entryArray.controls[rowIndex].get('LedgerCode')"
              (change)="changeLedgerValue(dataItem, rowIndex)"
            />
            <kendo-popup
              [anchor]="input"
              *ngIf="entryArray.controls[rowIndex].get('LedgerCode').invalid"
              popupClass="k-widget k-tooltip k-tooltip-validation k-invalid-msg"
            >
              <span class="k-icon k-i-warning"></span>
              Ledger Code is invalid
            </kendo-popup>
          </div>
          <div class="col-md-8 pr-0">
            <input
              #input
              class="k-textbox"
              [readonly]="true"
              [formControl]="entryArray.controls[rowIndex].get('LedgerName')"
            />
            <a (click)="openLedgerModal(rowIndex)"
              ><i
                class="fa fa-eye pull-right ledgerSelectIcon"
                aria-hidden="true"
              ></i>
            </a>
            <kendo-popup
              [anchor]="input"
              *ngIf="
                entryArray.controls[rowIndex].get('LedgerName').invalid &&
                rowSubmitted &&
                !(
                  isNew &&
                  entryArray.controls[rowIndex].get('LedgerName').untouched
                ) &&
                !entryArray.controls[rowIndex].get('LedgerCode')
              "
              popupClass="k-widget k-tooltip k-tooltip-validation k-invalid-msg"
            >
              <span class="k-icon k-i-warning"></span>
              Ledger name is required
            </kendo-popup>
          </div>
        </div> -->
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="DebitCredit"
      title="Debit"
      width="150"
      [hidden]="!columns.includes('DebitCredit')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <kendo-numerictextbox
          #ntb="popupAnchor"
          popupAnchor
          class="form-control"
          [decimals]="decimals"
          [format]="'c0'"
          [disabled]="
            entryArray.controls[rowIndex].get('DebitCredit').value == 'Credit'
          "
          [formControl]="entryArray.controls[rowIndex].get('Amount')"
          (change)="checkDebitValue(dataItem, rowIndex)"
        ></kendo-numerictextbox>
        <kendo-popup
          [anchor]="ntb.element"
          *ngIf="
            entryArray.controls[rowIndex].get('Amount').invalid &&
            rowSubmitted &&
            !entryArray.controls[rowIndex].get('Amount').untouched
          "
          popupClass="k-widget k-tooltip k-tooltip-validation k-invalid-msg"
        >
          <span class="k-icon k-i-warning"></span>
          Debit Amount is required
        </kendo-popup>
      </ng-template>
      <ng-template
        kendoGridFooterTemplate
        let-column
        let-columnIndex="columnIndex"
      >
        <span class="pull-right">
          Debit Total:
          <span [innerHTML]="calculateDebitTotal() | currencyFormat"></span>
        </span>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="DebitCredit"
      title="Credit"
      width="150"
      [hidden]="!columns.includes('DebitCredit')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <kendo-numerictextbox
          #ntb="popupAnchor"
          popupAnchor
          class="form-control"
          [decimals]="decimals"
          [format]="'c0'"
          [disabled]="
            entryArray.controls[rowIndex].get('DebitCredit').value == 'Debit'
          "
          [formControl]="entryArray.controls[rowIndex].get('Amount')"
          (change)="checkCreditValue(dataItem, rowIndex)"
        ></kendo-numerictextbox>

        <kendo-popup
          [anchor]="ntb.element"
          *ngIf="
            entryArray.controls[rowIndex].get('Amount').invalid &&
            rowSubmitted &&
            !(isNew && entryArray.controls[rowIndex].get('Amount').untouched)
          "
          popupClass="k-widget k-tooltip k-tooltip-validation k-invalid-msg"
        >
          <span class="k-icon k-i-warning"></span>
          Credit Amount is required
        </kendo-popup>
      </ng-template>
      <ng-template
        kendoGridFooterTemplate
        let-column
        let-columnIndex="columnIndex"
      >
        <span class="pull-right">
          Credit Total:
          <span [innerHTML]="calculateDebitTotal() | currencyFormat"></span>
        </span>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="ChequeNumber"
      title="Cheque Number"
      width="120"
      [hidden]="!columns.includes('ChequeNumber')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <input
          #input
          class="k-textbox"
          class="form-control"
          [formControl]="entryArray.controls[rowIndex].get('ChequeNumber')"
        />
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="ChequeDate"
      title="Cheque Date"
      width="150"
      [hidden]="!columns.includes('ChequeDate')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <kendo-datepicker
          [valuePrimitive]="true"
          [formControl]="entryArray.controls[rowIndex].get('ChequeDate')"
          [min]="min"
          [max]="max"
          class="form-control"
        ></kendo-datepicker>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="VoucherNumber"
      title="Voucher No"
      width="150"
      [hidden]="!columns.includes('VoucherNumber')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <input
          #ntb="popupAnchor"
          class="k-textbox"
          popupAnchor
          class="form-control"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
        />
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="Quantity"
      title="Quantity"
      width="80"
      [hidden]="!columns.includes('Quantity')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-column="column"
        let-rowIndex="rowIndex"
      >
        <kendo-numerictextbox
          popupAnchor
          class="form-control"
          [format]="'n0'"
          [min]="1"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
          (valueChange)="changeInvoiceValues(dataItem, rowIndex)"
        >
        </kendo-numerictextbox>
      </ng-template>
      <ng-template
        kendoGridFooterTemplate
        let-column
        let-columnIndex="columnIndex"
      >
        <span class="pull-right"> Total QTY: {{ calculateQtyTotal() }} </span>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="SalesRate"
      title="Sales Rate"
      width="80"
      [hidden]="!columns.includes('SalesRate')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-column="column"
        let-rowIndex="rowIndex"
      >
        <kendo-numerictextbox
          popupAnchor
          class="form-control"
          [decimals]="decimals"
          [spinners]="false"
          [format]="'c0'"
          [formControl]="entryArray.controls[rowIndex].get('SalesRate')"
          (valueChange)="changeInvoiceValues(dataItem, rowIndex)"
        >
        </kendo-numerictextbox>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="DiscPercentage"
      title="Disc%"
      width="80"
      [hidden]="!columns.includes('DiscPercentage')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-rowIndex="rowIndex"
        let-isNew="isNew"
        let-formGroup="formGroup"
      >
        <button
          #anchor
          class="btn-secondary"
          (click)="discountToggle(rowIndex)"
        >
          Discount
        </button>
        <kendo-popup
          #popup
          [anchor]="anchor"
          *ngIf="showDiscPopup && rowPopupIndexDisc == rowIndex"
          [animate]="animate"
          (anchorViewportLeave)="discountToggle(null)"
        >
          <div class="contentPopup">
            <div class="form-group">
              <label> Discount %</label>
              <kendo-numerictextbox
                [step]="1"
                [min]="0"
                class="form-control"
                [max]="100"
                [valuePrimitive]="true"
                [value]="percentage"
                [formControl]="
                  entryArray.controls[rowIndex].get('DiscPercentage')
                "
                (valueChange)="changeInvoiceValues(dataItem, rowIndex)"
              ></kendo-numerictextbox>
            </div>
            <div class="form-group">
              <label> Discount Amount</label>
              <kendo-numerictextbox
                popupAnchor
                class="form-control"
                [decimals]="decimals"
                [spinners]="false"
                [format]="'c0'"
                [formControl]="
                  entryArray.controls[rowIndex].get('DiscountAmount')
                "
                (valueChange)="discountAmountCalc(dataItem, rowIndex)"
              >
              </kendo-numerictextbox>
            </div>
            <button
              class="btn-primary btn"
              style="margin: auto; display: table;"
              (click)="discountToggle(null)"
            >
              Ok
            </button>
          </div>
        </kendo-popup>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="TaxID"
      title="Select Tax"
      width="110"
      [hidden]="!columns.includes('TaxID')"
    >
      <ng-template
        kendoGridCellTemplate
        let-isNew="isNew"
        let-dataItem="dataItem"
        let-rowIndex="rowIndex"
        let-formGroup="formGroup"
        let-column="column"
      >
        <kendo-dropdownlist
          class="form-control"
          [data]="gridServices.taxList"
          textField="Name"
          valueField="ID"
          [valuePrimitive]="true"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
          (valueChange)="handleTaxChange($event, rowIndex)"
        >
          <ng-template kendoDropDownListItemTemplate let-dataItem>
            <span class="template">{{ dataItem.Name }}</span
            >({{ dataItem.Rate }} %)
          </ng-template>
        </kendo-dropdownlist>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="Amount"
      title="Amount"
      width="120"
      [hidden]="!columns.includes('Amount') || voucherType == 'JRNL'"
    >
      <ng-template
        kendoGridCellTemplate
        let-isNew="isNew"
        let-dataItem="dataItem"
        let-rowIndex="rowIndex"
        let-formGroup="formGroup"
        let-column="column"
      >
        <kendo-numerictextbox
          *ngIf="
            voucherType == 'CASH_RCPT' ||
            voucherType == 'CASH_PMNT' ||
            voucherType == 'BANK_RCPT'
          "
          #ntb="popupAnchor"
          popupAnchor
          class="form-control"
          [decimals]="decimals"
          [spinners]="false"
          [format]="'c0'"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
        ></kendo-numerictextbox>
        <div *ngIf="voucherType == 'SALES'">
          <span class="small_text"
            >Total :&nbsp; &nbsp;
            <span
              [innerHTML]="
                entryArray.controls[rowIndex].get('Amount').value
                  | currencyFormat
              "
            ></span
          ></span>

          <span class="small_text"
            >Discount :&nbsp; &nbsp;
            <span
              [innerHTML]="
                entryArray.controls[rowIndex].get('DiscountAmount').value
                  | currencyFormat
              "
            ></span
          ></span>
          <span class="small_text"
            >Net :&nbsp; &nbsp;
            <span
              [innerHTML]="
                entryArray.controls[rowIndex].get('NetAmount').value
                  | currencyFormat
              "
            ></span
          ></span>
        </div>
      </ng-template>
      <ng-template
        kendoGridFooterTemplate
        let-column
        let-columnIndex="columnIndex"
        *ngIf="voucherType == 'SALES'"
      >
        <label>
          Gross :
          <span [innerHTML]="calculateGrossTotal() | currencyFormat"></span>
        </label>

        <label>
          Net : <span [innerHTML]="calculateNetTotal | currencyFormat"></span>
        </label>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="LedgerBalance"
      title="Ledger Balance"
      width="150"
      [hidden]="!columns.includes('LedgerBalance')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <input
          #input
          class="k-textbox"
          style="text-align: right;"
          class="form-control"
          [readonly]="true"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
        />
      </ng-template>
      <ng-template
        kendoGridFooterTemplate
        let-column
        let-columnIndex="columnIndex"
        *ngIf="voucherType == 'JRNL'"
      >
        <span class="pull-right">
          Difference :
          <span [innerHTML]="debitTotal - creditTotal | currencyFormat"></span>
        </span>
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-column
      field="VoucherType"
      title="V. Type"
      width="150"
      [hidden]="!columns.includes('VoucherType')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-formGroup="formGroup"
        let-isNew="isNew"
        let-rowIndex="rowIndex"
      >
        <kendo-dropdownlist
          class="form-control"
          [data]="gridServices.voucherType"
          textField="VouchName"
          valueField="VouchType"
          [valuePrimitive]="true"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
        >
        </kendo-dropdownlist>
      </ng-template>
    </kendo-grid-column>
    <kendo-grid-column
      field="Remarks"
      title="Remarks"
      width="120"
      [hidden]="!columns.includes('Remarks')"
    >
      <ng-template
        kendoGridCellTemplate
        let-dataItem="dataItem"
        let-column="column"
        let-rowIndex="rowIndex"
        let-isNew="isNew"
        let-formGroup="formGroup"
      >
        <input
          #ntb="popupAnchor"
          popupAnchor
          class="k-textbox"
          class="form-control"
          [formControl]="entryArray.controls[rowIndex].get(column.field)"
        />
      </ng-template>
    </kendo-grid-column>

    <kendo-grid-command-column title="Action" width="60">
      <ng-template kendoGridCellTemplate let-isNew="isNew">
        <button kendoGridRemoveCommand>
          <i class="fas fa-trash-alt mr-2 cursor-pointer" tooltip="Delete"></i>
        </button>
        <button kendoGridSaveCommand [disabled]="formGroup?.invalid">
          {{ isNew ? "Add" : "Update" }}
        </button>
        <button kendoGridCancelCommand>
          {{ isNew ? "Discard changes" : "Cancel" }}
        </button>
      </ng-template>
    </kendo-grid-command-column>
  </kendo-grid>
</div>
